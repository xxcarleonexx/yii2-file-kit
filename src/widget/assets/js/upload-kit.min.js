(function($){jQuery.fn.yiiUploadKit=function(options){var $input=this,$container=$input.parent("div"),$files=$("<ul>",{class:"files"}).insertBefore($input),$emptyInput=$container.find(".empty-value"),methods={init:function(){options.multiple&&($input.attr("multiple",!0),$input.attr("name",$input.attr("name")+"[]")),$container.addClass("upload-kit"),options.sortable&&$files.sortable({placeholder:"upload-kit-item sortable-placeholder",tolerance:"pointer",forcePlaceholderSize:!0,update:function(){methods.updateOrder()}}),$input.wrapAll($("<li class=\"upload-kit-input\"></div>")).after($("<span class=\"glyphicon glyphicon-plus-sign add\"></span>")).after($("<span class=\"glyphicon glyphicon-circle-arrow-down drag\"></span>")).after($("<span/>",{"data-toggle":"popover",class:"glyphicon glyphicon-exclamation-sign error-popover"})).after("<div class=\"progress\"><div class=\"progress-bar\" role=\"progressbar\" aria-valuenow=\"0\" aria-valuemin=\"0\" aria-valuemax=\"100\"></div></li>"),$files.on("click",".upload-kit-item .remove",methods.removeItem),methods.checkInputVisibility(),methods.fileuploadInit(),methods.dragInit(),options.acceptFileTypes&&!(options.acceptFileTypes instanceof RegExp)&&(options.acceptFileTypes=new RegExp(eval(options.acceptFileTypes)))},fileuploadInit:function(){var a=$input.fileupload({name:options.name||"file",url:options.url,dropZone:$input.parents(".upload-kit-input"),dataType:"json",singleFileUploads:!1,multiple:options.multiple,maxNumberOfFiles:options.maxNumberOfFiles,maxFileSize:options.maxFileSize,acceptFileTypes:options.acceptFileTypes,minFileSize:options.minFileSize,messages:options.messages,process:!0,getNumberOfFiles:methods.getNumberOfFiles,start:function(a,b){$container.find(".upload-kit-input").removeClass("error").addClass("in-progress"),$input.trigger("start"),void 0!==options.start&&options.start(a,b)},processfail:function(a,b){b.files.error&&methods.showError(b.files[0].error)},progressall:function(a,b){var c=parseInt(100*(b.loaded/b.total),10);$container.find(".progress-bar").attr("aria-valuenow",c).css("width",c+"%").text(c+"%")},done:function(a,b){$.each(b.result.files,function(a,b){if(!b.error){var c=methods.createItem(b);c.appendTo($files)}else methods.showError(b.errors)}),methods.handleEmptyValue(),methods.checkInputVisibility(),$input.trigger("done"),void 0!==options.done&&options.done(a,b)},fail:function(a,b){methods.showError(b.errorThrown),void 0!==options.fail&&options.fail(a,b)},always:function(a,b){$container.find(".upload-kit-input").removeClass("in-progress"),$input.trigger("always"),void 0!==options.always&&options.always(a,b)}});options.files&&(options.files.sort(function(c,a){return parseInt(c.order)-parseInt(a.order)}),a.fileupload("option","done").call(a,$.Event("done"),{result:{files:options.files}}),methods.handleEmptyValue(),methods.checkInputVisibility())},dragInit:function(){$(document).on("dragover",function(){$(".upload-kit-input").addClass("drag-highlight")}),$(document).on("dragleave drop",function(){$(".upload-kit-input").removeClass("drag-highlight")})},showError:function(a){$.fn.popover?$container.find(".error-popover").attr("data-content",a).popover({html:!0,trigger:"hover"}).popover("show"):$container.find(".error-popover").text(a),$container.find(".upload-kit-input").addClass("error")},removeItem:function(){var a=$(this),b=a.data("url");b&&$.ajax({url:b,type:"DELETE"}),a.parents(".upload-kit-item").remove(),methods.handleEmptyValue(),methods.checkInputVisibility()},createItem:function(a){var b=options.name,c=methods.getNewItemIndex();options.multiple&&(b+="["+c+"]"),console.log(options);var d=$("<li>",{class:"upload-kit-item done",value:c}).append($("<input/>",{name:b+"["+options.pathAttributeName+"]",value:a[options.pathAttribute],type:"hidden"})).append($("<input/>",{name:b+"[name]",value:a.name,type:"hidden"})).append($("<input/>",{name:b+"[size]",value:a.size,type:"hidden"})).append($("<input/>",{name:b+"[type]",value:a.type,type:"hidden"})).append($("<input/>",{name:b+"[order]",value:a.order,type:"hidden","data-role":"order"})).append($("<input/>",{name:b+"["+options.baseUrlAttributeName+"]",value:a[options.baseUrlAttribute],type:"hidden"})).append($("<span/>",{class:"name",title:a.name,text:options.showPreviewFilename?a.name:null})).append($("<span/>",{class:"glyphicon glyphicon-remove-circle remove","data-url":a.delete_url}));return(!a.type||-1!==a.type.search(/image\/.*/g))&&options.previewImage?(d.removeClass("not-image").addClass("image"),d.prepend($("<img/>",{src:a[options.baseUrlAttribute]+"/"+a[options.pathAttribute]})),d.find("span.type").text("")):(d.removeClass("image").addClass("not-image"),d.css("backgroundImage",""),d.find("span.name").text(a.name)),d},checkInputVisibility:function(){var a=$container.find(".upload-kit-input");options.maxNumberOfFiles&&methods.getNumberOfFiles()>=options.maxNumberOfFiles?a.hide():a.show()},handleEmptyValue:function(){0<methods.getNumberOfFiles()?$emptyInput.val(methods.getNumberOfFiles()):$emptyInput.removeAttr("value")},getNumberOfFiles:function(){return $container.find(".files .upload-kit-item").length},getNewItemIndex:function(){var a=[];return $container.find(".files .upload-kit-item").each(function(){a.push($(this).val())}),a.length?Math.max(...a)+1:0},updateOrder:function(){$files.find(".upload-kit-item").each(function(a,b){$(b).find("input[data-role=order]").val(a)})}};return methods.init.apply(this),this}})(jQuery);
