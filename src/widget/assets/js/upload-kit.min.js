(function($){jQuery.fn.yiiUploadKit=function(options){var $input=this,$container=$input.parent('div'),$files=$('<ul>',{'class':'files'}).insertBefore($input),$emptyInput=$container.find('.empty-value'),methods={init:function(){options.multiple&&($input.attr('multiple',!0),$input.attr('name',$input.attr('name')+'[]')),$container.addClass('upload-kit'),options.sortable&&$files.sortable({placeholder:'upload-kit-item sortable-placeholder',tolerance:'pointer',forcePlaceholderSize:!0,update:function(){methods.updateOrder()}}),$input.wrapAll($('<li class="upload-kit-input"></div>')).after($('<span class="glyphicon glyphicon-plus-sign add"></span>')).after($('<span class="glyphicon glyphicon-circle-arrow-down drag"></span>')).after($('<span/>',{'data-toggle':'popover','class':'glyphicon glyphicon-exclamation-sign error-popover'})).after('<div class="progress"><div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div></li>'),$files.on('click','.upload-kit-item .remove',methods.removeItem),methods.checkInputVisibility(),methods.fileuploadInit(),methods.dragInit(),options.acceptFileTypes&&!(options.acceptFileTypes instanceof RegExp)&&(options.acceptFileTypes=new RegExp(eval(options.acceptFileTypes)))},fileuploadInit:function(){var c=$input.fileupload({name:options.name||'file',url:options.url,dropZone:$input.parents('.upload-kit-input'),dataType:'json',singleFileUploads:!1,multiple:options.multiple,maxNumberOfFiles:options.maxNumberOfFiles,maxFileSize:options.maxFileSize,acceptFileTypes:options.acceptFileTypes,minFileSize:options.minFileSize,messages:options.messages,process:!0,getNumberOfFiles:methods.getNumberOfFiles,start:function(d,f){$container.find('.upload-kit-input').removeClass('error').addClass('in-progress'),$input.trigger('start'),void 0!==options.start&&options.start(d,f)},processfail:function(d,f){f.files.error&&methods.showError(f.files[0].error)},progressall:function(d,f){var g=parseInt(100*(f.loaded/f.total),10);$container.find('.progress-bar').attr('aria-valuenow',g).css('width',g+'%').text(g+'%')},done:function(d,f){$.each(f.result.files,function(g,h){if(!h.error){var i=methods.createItem(h);i.appendTo($files)}else methods.showError(h.errors)}),methods.handleEmptyValue(),methods.checkInputVisibility(),$input.trigger('done'),void 0!==options.done&&options.done(d,f)},fail:function(d,f){methods.showError(f.errorThrown),void 0!==options.fail&&options.fail(d,f)},always:function(d,f){$container.find('.upload-kit-input').removeClass('in-progress'),$input.trigger('always'),void 0!==options.always&&options.always(d,f)}});options.files&&(options.files.sort(function(d,f){return parseInt(d.order)-parseInt(f.order)}),c.fileupload('option','done').call(c,$.Event('done'),{result:{files:options.files}}),methods.handleEmptyValue(),methods.checkInputVisibility())},dragInit:function(){$(document).on('dragover',function(){$('.upload-kit-input').addClass('drag-highlight')}),$(document).on('dragleave drop',function(){$('.upload-kit-input').removeClass('drag-highlight')})},showError:function(c){$.fn.popover&&$container.find('.error-popover').attr('data-content',c).popover({html:!0,trigger:'hover'}),$container.find('.upload-kit-input').addClass('error')},removeItem:function(){var d=$(this),f=d.data('url');f&&$.ajax({url:f,type:'DELETE'}),d.parents('.upload-kit-item').remove(),methods.handleEmptyValue(),methods.checkInputVisibility()},createItem:function(c){var d=options.name,f=methods.getNewItemIndex();options.multiple&&(d+='['+f+']'),console.log(options);var g=$('<li>',{'class':'upload-kit-item done',value:f}).append($('<input/>',{name:d+'['+options.pathAttributeName+']',value:c[options.pathAttribute],type:'hidden'})).append($('<input/>',{name:d+'[name]',value:c.name,type:'hidden'})).append($('<input/>',{name:d+'[size]',value:c.size,type:'hidden'})).append($('<input/>',{name:d+'[type]',value:c.type,type:'hidden'})).append($('<input/>',{name:d+'[order]',value:c.order,type:'hidden','data-role':'order'})).append($('<input/>',{name:d+'['+options.baseUrlAttributeName+']',value:c[options.baseUrlAttribute],type:'hidden'})).append($('<span/>',{'class':'name',title:c.name,text:options.showPreviewFilename?c.name:null})).append($('<span/>',{'class':'glyphicon glyphicon-remove-circle remove','data-url':c.delete_url}));return(!c.type||-1!==c.type.search(/image\/.*/g))&&options.previewImage?(g.removeClass('not-image').addClass('image'),g.prepend($('<img/>',{src:c[options.baseUrlAttribute]+'/'+c[options.pathAttribute]})),g.find('span.type').text('')):(g.removeClass('image').addClass('not-image'),g.css('backgroundImage',''),g.find('span.name').text(c.name)),g},checkInputVisibility:function(){var c=$container.find('.upload-kit-input');options.maxNumberOfFiles&&methods.getNumberOfFiles()>=options.maxNumberOfFiles?c.hide():c.show()},handleEmptyValue:function(){0<methods.getNumberOfFiles()?$emptyInput.val(methods.getNumberOfFiles()):$emptyInput.removeAttr('value')},getNumberOfFiles:function(){return $container.find('.files .upload-kit-item').length},getNewItemIndex:function(){var c=[];return $container.find('.files .upload-kit-item').each(function(){c.push($(this).val())}),c.length?Math.max(...c)+1:0},updateOrder:function(){$files.find('.upload-kit-item').each(function(c,d){$(d).find('input[data-role=order]').val(c)})}};return methods.init.apply(this),this}})(jQuery);
